modify my whole template add validation,  also please provide proper implementation of the heatmap and the time-series maps: here are their objects:
heatmap data= 
{
    "data": [
        [
            -8.3041,
            33.4417,
            4.4
        ],
        [
            -9.0536,
            33.7392,
            4.7
        ],
        [
            -8.3046,
            33.3209,
            4.5
        ],
        [
            -9.2724,
            33.584,
            4.5
        ],
        [
            -8.6395,
            32.235,
            4.7
        ],
        [
            -8.2935,
            33.3074,
            4.4
        ],
        [
            -9.1974,
            33.7049,
            4.7
        ],
        [
            -9.629,
            33.1351,
            4.6
        ],
        [
            -9.0603,
            33.6281,
            4.4
        ],
        [
            -8.8431,
            33.5007,
            4.5
        ],
        [
            -8.1318,
            33.4916,
            4.3
        ],
        [
            -8.7541,
            32.2774,
            4.5
        ],
        [
            -8.3837,
            33.663,
            4.3
        ],
        [
            -8.4538,
            32.9321,
            4.6
        ],
        [
            -8.9738,
            32.4336,
            4.4
        ],
        [
            -8.415,
            32.6908,
            4.9
        ],
        [
            -8.5002,
            32.1863,
            3.6
        ],
        [
            -9.1723,
            33.8039,
            4.6
        ],
        [
            -8.7059,
            33.6895,
            4.7
        ],
        [
            -8.1108,
            33.0988,
            4.4
        ],
        [
            -8.3057,
            33.7143,
            4.4
        ],
        [
            -8.942,
            32.163,
            4.6
        ],
        [
            -9.4825,
            33.4578,
            4.5
        ],
        [
            -8.5104,
            33.3631,
            4.7
        ],
        [
            -8.9946,
            33.3245,
            4
        ],
        [
            -8.7932,
            32.9927,
            4.4
        ]
    ],
    "center": {
        "lat": -9,
        "lon": 33
    },
    "count": 26
}

time_series=
{
    "time_series": {
        "labels": [
            "1973-01",
            "1973-02",
            "1973-03",
            "1973-04",
            "1973-05",
            "1973-06",
            "1973-07",
            "1973-08",
            "1973-09",
            "1973-10",
            "1973-11",
            "1973-12",
            "1974-01",
            "1974-02",
            "1974-03",
            "1974-04",
            "1974-05",
            "1974-06",
            "1974-07",
            "1974-08",
            "1974-09",
            "1974-10",
            "1974-11",
            "1974-12",
            "1975-01",
            "1975-02",
            "1975-03",
            "1975-04",
            "1975-05",
            "1975-06",
            "1975-07",
            "1975-08",
            "1975-09",
            "1975-10",
            "1975-11",
            "1975-12",
            "1976-01",
            "1976-02",
            "1976-03",
            "1976-04",
            "1976-05",
            "1976-06",
            "1976-07",
            "1976-08",
            "1976-09",
            "1976-12",
            "1977-01",
            "1977-02",
            "1977-03",
            "1977-04",
            "1977-05",
            "1977-06",
            "1977-07",
            "1977-10",
            "1977-11",
            "1977-12",
            "1978-01",
            "1978-02",
            "1978-03",
            "1978-04",
            "1978-05",
            "1978-07",
            "1978-08",
            "1978-09",
            "1978-10",
            "1978-11",
            "1978-12",
            "1979-01",
            "1979-02",
            "1979-03",
            "1979-04",
            "1979-05",
            "1979-06"
            "2023-08",
            "2023-09",
            "2023-10",
            "2023-11",
            "2023-12",
            "2024-01",
            "2024-02",
            "2024-03",
            "2024-05",
            "2024-06",
            "2024-07",
            "2024-08",
            "2024-10",
            "2024-11",
            "2024-12",
            "2025-01"
        ],
        "count": [
            4,
            2,
            2,
            1,
            1,
            2,
            2,
            2,
            3,
            2,
            1,
            4,
            4,
            4,
            3,
            4,
            3,
            4,
            
        ],
        "avg_magnitude": [
            4.575,
            4.550000000000001,
            4.55,
            4.5,
            4.6,
            4.65,
            4.9,
            4.5,
            4.566666666666666,
            4.7,
            4.4,
            4.525,
            4.65,
            4.6,
            4.733333333333333,
            4.65,
            4.6000000000000005,
            4.6,
            4.5,
            4.8,
            4.6,
            4.66,
            4.55,
            4.671428571428572,
            4.5,
            4.550000000000001,
            4.6,
            4.5,
            4.699999999999999,
            4.9,
            4.7,
            4.6000000000000005,
            4.75,
            4.6000000000000005,
            4.675,
            4.574999999999999,
            4.4,
            4.75,
            4.166666666666667,
            4.1,
            4.6,
            4.325,
            4.5,
            4.5200000000000005,
            4.65,
            4.8,
            4.766666666666667,
            4.3,
            4.550000000000001,
            4.4,
            3.9,
            4.4,
            4.5,
            4.566666666666666,
            4.533333333333333,
            4.5,
            4.55,
            4.6000000000000005,
            4.7,
            4.5,
            4.35,
            4.666666666666667,
            4.6,
            4.55,
            4.6,
            4.6,
            4.574999999999999,
            4.625,
            4.65,
            4.725,
            4.525,
            4.5200000000000005,
            4.75,
            4.4,
            4.66,
            4.6,
            4.65,
            4.6,
            4.68,
            4.666666666666667,
            4.7,
            4.766666666666667,
            4.433333333333334,
            4.566666666666666,
            4.66,
            4.55,
            4.616666666666666,
            4.533333333333334,
            4.733333333333333,
            4.8,
            4.5,
            4.7,
            4.7,
            4.4,
            4.522222222222222,
            4.9,
            4.65,
            4.3,
            4.7,
            4.366666666666667,
            4.35
        ],
        "max_magnitude": [
            4.8,
            4.7,
            4.6,
            4.5,
            4.6,
            4.7,
            5,
            4.5,
            4.7,
            4.7,
            4.4,
            4.7,
            4.9,
            4.8,
            4.8,
            4.7,
            4.8,
            4.7,
            4.5,
            4.8,
            4.7,
            5,
            4.8,
            4.8,
            4.8,
            4.7,
            4.6,
            4.8,
            4.8,
            4.9,
            4.9,
            4.9,
            4.9,
            4.7,
            4.7,
            4.8,
            4.4,
            4.8,
            4.5,
            4.1,
            4.6,
            4.6,
            4.6,
            4.6,
            4.7,
            4.8,
            4.9,
            4.6,
            4.7,
            4.4,
            3.9,
            4.6,
            4.7,
            4.6,
            5,
            4.9,
            4.5,
            4.5
        ]
    },
    "yearly_trends": {
        "years": [
            1973,
            1974,
            1975,
            1976,
            1977,
            1978,
            1979,
            1980,
            1981,
            1982,
            1983,
            1984,
            1985,
            1986,
            1987,
            1988,
            1989,
            1990,
            1991,
            1992,
            1993,
            1994,
            1995,
            1996,
            1997,
            1998,
            1999,
            2000,
            2001,
            2002,
            2003,
            2004,
            2005,
            2006,
            2007,
            2008,
            2009,
            2010,
            2011,
            2012,
            2013,
            2014,
            2015,
            2016,
            2017,
            2018,
            2019,
            2020,
            2021,
            2022,
            2023,
            2024,
            2025
        ],
        "count": [
            26,
            47,
            43,
            22,
            27,
            34,
            37,
            36,
            38,
            29,
            40,
            47,
            33,
            45,
            24,
            22,
            28,
            45,
            23,
            22,
            29,
            38,
            21,
            20,
            25,
            43,
            47,
            30,
            24,
            34,
            49,
            36,
            26,
            24,
            33,
            21,
            25,
            42,
            27,
            20,
            42,
            20,
            41,
            39,
            28,
            23,
            41,
            46,
            31,
            49,
            31,
            18,
            2
        ],
        "avg_magnitude": [
            4.588461538461538,
            4.631914893617021,
            4.618604651162791,
            4.459090909090909,
            4.481481481481482,
            4.582352941176471,
            4.624324324324324,
            4.625,
            4.5552631578947365,
            4.624137931034483,
            4.58,
            4.6063829787234045,
            4.593939393939394,
            4.58,
            4.554166666666666,
            4.590909090909091,
            4.6000000000000005,
            4.595555555555555,
            4.6,
            4.622727272727273,
            4.582758620689655,
            4.605263157894737,
            4.514285714285714,
            4.615,
            4.572,
            4.609302325581395,
            4.551063829787235,
            4.6,
            4.533333333333333,
            4.535294117647059,
            4.5285714285714285,
            4.577777777777778,
            4.611538461538462,
            4.5625,
            4.627272727272727,
            4.566666666666667,
            4.584,
            4.647619047619047,
            4.5777777777777775,
            4.5649999999999995,
            4.55,
            4.575,
            4.582926829268293,
            4.602564102564102,
            4.564285714285714,
            4.504347826086956,
            4.621951219512195,
            4.615217391304348,
            4.664516129032258,
            4.563265306122449,
            4.580645161290323,
            4.4944444444444445,
            4.35
        ],
        "max_magnitude": [
            5,
            5,
            4.9,
            4.8,
            5,
            4.9,
            4.9,
            4.9,
            4.9,
            5,
            4.9,
            5,
            4.8,
            4.9,
            5,
            4.8,
            5.1,
            4.9,
            4.9,
            5,
            4.9,
            5,
            4.9,
            4.9,
            4.9,
            5,
            4.9,
            4.9,
            4.9,
            4.9,
            4.9,
            4.9,
            4.9,
            4.8,
            4.9,
            4.9,
            4.9,
            4.9,
            4.9,
            5,
            5,
            5,
            4.9,
            5,
            5,
            4.9,
            5,
            4.9,
            5,
            5,
            5,
            5,
            4.5
        ]
    }
}

# template
{% extends "ai/base.html" %}
{% load static %}

{% block title %}Earthquake Analytics Dashboard{% endblock %}

{% block extra_head %}
<!-- Leaflet for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- Chart.js for visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Heatmap.js for heatmap visualization -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4 text-blue-600">Earthquake Analytics Dashboard</h1>
  
  <!-- Filter Form -->
  <div class="bg-gray-100 p-6 rounded-lg mb-6">
    <form method="GET" action="{% url 'ai:analytics' %}">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
          <input type="number" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="latitude" name="latitude" 
                 value="{{ filter.latitude|default_if_none:'' }}" placeholder="-9.0000">
        </div>
        <div>
          <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
          <input type="number" step="0.0001" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="longitude" name="longitude"
                 value="{{ filter.longitude|default_if_none:'' }}" placeholder="33.0000">
        </div>
        <div>
          <label for="radius" class="block text-sm font-medium text-gray-700">Radius (degrees)</label>
          <input type="number" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="radius" name="radius"
                 value="{{ filter.radius|default:'1.0' }}" placeholder="1.0">
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Apply Filter</button>
          <a href="{% url 'ai:analytics' %}" class="px-4 py-2 border border-gray-500 text-gray-500 rounded hover:bg-gray-100">Reset</a>
        </div>
      </div>
    </form>
  </div>
  
  {% if filter %}
  <div class="bg-blue-100 text-blue-700 p-4 rounded mb-4">
    <i class="fas fa-filter me-2"></i> Showing data for region: Latitude {{ filter.latitude }}, Longitude {{ filter.longitude }}, Radius {{ filter.radius }} degrees
  </div>
  {% endif %}
  
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Regional Stats Card -->
    <div class="bg-white rounded-lg shadow-md p-6 h-full">
      <h3 class="text-blue-900 mb-4 font-mono font-semibold border-b-2 border-green-600 pb-2"><i class="fas fa-chart-bar me-2"></i> Regional Statistics</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.count|default:'0' }}</div>
          <div class="text-sm text-gray-600 font-sans">Total Events</div>
        </div>
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.avg_magnitude|floatformat:2 }}</div>
          <div class="text-sm text-gray-600 font-sans">Avg. Magnitude</div>
        </div>
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.max_magnitude|floatformat:1 }}</div>
          <div class="text-sm text-gray-600 font-sans">Max Magnitude</div>
        </div>
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.min_magnitude|floatformat:1 }}</div>
          <div class="text-sm text-gray-600 font-sans">Min Magnitude</div>
        </div>
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.std_magnitude|floatformat:2 }}</div>
          <div class="text-sm text-gray-600 font-sans">Std Deviation</div>
        </div>
        <div class="text-center p-4 rounded-md bg-gray-100 transition-all duration-300 hover:shadow-lg hover:-translate-y-[2px]">
          <div class="text-2xl font-bold text-blue-900">{{ regional_data.recent_events }}</div>
          <div class="text-sm text-gray-600 font-sans">Recent (5yr)</div>
        </div>
      </div>
    </div>
    
    <!-- Risk Assessment Card -->
    <div class="bg-white rounded-lg shadow-md p-6 h-full">
      <h3 class="text-blue-900 mb-4 font-mono font-semibold border-b-2 border-green-600 pb-2"><i class="fas fa-exclamation-triangle me-2"></i> Seismic Risk Assessment</h3>
      {% if regional_data.max_magnitude >= 5.0 %}
      <div class="bg-red-100 text-red-700 p-4 rounded mb-3">
        <strong>High Risk Area!</strong> This region has experienced earthquakes of magnitude {{ regional_data.max_magnitude|floatformat:1 }}.
      </div>
      {% elif regional_data.max_magnitude >= 4.0 %}
      <div class="bg-yellow-100 text-yellow-700 p-4 rounded mb-3">
        <strong>Moderate Risk Area.</strong> This region has experienced earthquakes of magnitude {{ regional_data.max_magnitude|floatformat:1 }}.
      </div>
      {% else %}
      <div class="bg-green-100 text-green-700 p-4 rounded mb-3">
        <strong>Low Risk Area.</strong> No major earthquakes recorded in this region.
      </div>
      {% endif %}
      
      <div class="mb-3">
        <h5>Risk Factors:</h5>
        <ul>
          <li>Peak magnitude: <span class="bg-yellow-400 text-gray-800 px-2 py-1 rounded font-medium">{{ regional_data.max_magnitude|floatformat:1 }}</span></li>
          <li>Event frequency: {{ regional_data.count }} events recorded</li>
          <li>Recent activity: {{ regional_data.recent_events }} events in past 5 years</li>
        </ul>
      </div>
      
      <p><i class="fas fa-info-circle me-1"></i> <small>Risk assessment is based on historical data and should not be used as the sole basis for safety decisions.</small></p>
    </div>
    
    <!-- Heatmap Card -->
    <div class="bg-white rounded-lg shadow-md p-6 h-full">
      <h3 class="text-blue-900 mb-4 font-mono font-semibold border-b-2 border-green-600 pb-2"><i class="fas fa-map-marked-alt me-2"></i> Earthquake Heatmap</h3>
      <div id="earthquake-map" class="h-[400px] rounded-lg overflow-hidden"></div>
      <div class="mt-2 text-center">
        <small class="text-gray-500">Heatmap shows the concentration of seismic events. Red areas indicate higher activity.</small>
      </div>
    </div>
    
    <!-- Time Series Card -->
    <div class="bg-white rounded-lg shadow-md p-6 h-full">
      <h3 class="text-blue-900 mb-4 font-mono font-semibold border-b-2 border-green-600 pb-2"><i class="fas fa-chart-line me-2"></i> Temporal Analysis</h3>
      <div class="h-[350px] relative">
        <canvas id="timeSeriesChart"></canvas>
      </div>
      <div class="mt-2 text-center">
        <small class="text-gray-500">Chart shows earthquake frequency and magnitude distribution over time.</small>
      </div>
    </div>
  </div>
  
  <div class="mt-4">
    <div class="bg-white rounded-lg shadow-md p-6 h-full">
      <h3 class="text-blue-900 mb-4 font-mono font-semibold border-b-2 border-green-600 pb-2"><i class="fas fa-database me-2"></i> Data Distribution</h3>
      <div class="h-[350px] relative">
        <canvas id="magnitudeDistribution"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Leaflet map for heatmap
    const map = L.map('earthquake-map').setView([{{ filter.latitude|default:'-6.0' }}, {{ filter.longitude|default:'35.0' }}], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Parse heatmap data
    const heatmapDataRaw = '{{ heatmap_data|escapejs }}';
    let heatmapData;
    try {
      heatmapData = JSON.parse(heatmapDataRaw);
      console.log('Heatmap Data:', heatmapData);  // Debug: Check data in console
      if (!Array.isArray(heatmapData) || heatmapData.length === 0) {
        throw new Error('Heatmap data is empty or not an array');
      }
    } catch (e) {
      console.error('Error parsing heatmap data:', e);
      document.getElementById('earthquake-map').innerHTML = '<p class="text-red-500 text-center">Error loading heatmap</p>';
      heatmapData = [];
    }

    // Render heatmap
    if (heatmapData.length > 0) {
      const heatPoints = heatmapData.map(point => {
        if (point.lat && point.lon && point.intensity) {
          return [point.lat, point.lon, point.intensity];
        }
        console.warn('Invalid heatmap point:', point);
        return null;
      }).filter(point => point !== null);
      
      if (heatPoints.length > 0) {
        L.heatLayer(heatPoints, {
          radius: 20,
          blur: 15,
          maxZoom: 10,
          gradient: {0.4: 'blue', 0.65: 'lime', 0.8: 'yellow', 1: 'red'}
        }).addTo(map);
      } else {
        document.getElementById('earthquake-map').innerHTML = '<p class="text-red-500 text-center">No valid heatmap data</p>';
      }
    }

    // Add filter marker and circle if applicable
    {% if filter %}
    L.marker([{{ filter.latitude }}, {{ filter.longitude }}])
      .addTo(map)
      .bindPopup('Selected location');
    L.circle([{{ filter.latitude }}, {{ filter.longitude }}], {
      color: '#3E8E41',
      fillColor: '#3E8E41',
      fillOpacity: 0.1,
      radius: {{ filter.radius|default:'1.0' }} * 111000  // Degrees to meters (approx)
    }).addTo(map);
    {% endif %}
    
    // Parse time-series data
    const timeSeriesDataRaw = '{{ time_series|escapejs }}';
    let timeSeriesData;
    try {
      timeSeriesData = JSON.parse(timeSeriesDataRaw);
      console.log('Time Series Data:', timeSeriesData);  // Debug: Check data in console
      if (!timeSeriesData.labels || !timeSeriesData.counts || !timeSeriesData.magnitudes) {
        throw new Error('Missing required time-series fields');
      }
    } catch (e) {
      console.error('Error parsing time-series data:', e);
      document.getElementById('timeSeriesChart').parentElement.innerHTML = '<p class="text-red-500 text-center">Error loading time-series</p>';
      timeSeriesData = {};
    }

    // Render time-series chart
    const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
    if (timeSeriesData.labels && timeSeriesData.counts && timeSeriesData.magnitudes) {
      new Chart(timeSeriesCtx, {
        type: 'line',
        data: {
          labels: timeSeriesData.labels,
          datasets: [
            {
              label: 'Earthquake Count',
              data: timeSeriesData.counts,
              borderColor: '#003366',
              backgroundColor: 'rgba(0, 51, 102, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.2,
              yAxisID: 'y'
            },
            {
              label: 'Avg Magnitude',
              data: timeSeriesData.magnitudes,
              borderColor: '#FFC107',
              backgroundColor: 'rgba(255, 193, 7, 0)',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 3,
              pointBackgroundColor: '#FFC107',
              tension: 0.2,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { title: { display: true, text: 'Year' } },
            y: { 
              type: 'linear', 
              position: 'left', 
              title: { display: true, text: 'Event Count' }
            },
            y1: { 
              type: 'linear', 
              position: 'right', 
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'Magnitude' },
              min: 0,
              max: 10
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}